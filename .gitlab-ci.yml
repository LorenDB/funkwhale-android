image: jangrewe/gitlab-ci-android

stages:
- build
- deploy


.build:
  stage: build
  before_script:
  - export GRADLE_USER_HOME=$(pwd)/.gradle
  - chmod +x ./gradlew
  - mkdir -p .android && touch .android/repositories.cfg
  script:
  - echo "Overwrite me"

  cache:
    key: ${CI_PROJECT_ID}
    paths:
    - .gradle/

  artifacts:
    paths:
    - app/build/outputs/apk/debug/app-debug.apk

build-develop:
  extends: .build
  script:
  - echo -n $SIGNING_KEY_STORE | base64 -d > app/android.keystore
  - ./gradlew assembleDebug -Psigning.store=android.keystore -Psigning.store_passphrase=$SIGNING_KEY_PASS -Psigning.key_passphrase=$SIGNING_KEY_PASS
  only:
  - develop

build-bleeding-edge:
  extends: .build
  script:
  - ./gradlew assembleDebug
  except:
  - develop

deploy-develop:
  stage: deploy
  only: 
  - develop
  script:
  - eval `ssh-agent -s`
  - ssh-add <(echo "$SSH_PRIVATE_KEY")
  - scp -o StrictHostKeyChecking=no app/build/outputs/apk/debug/app-debug.apk fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/repo/audio.funkwhale.ffa.dev-$CI_COMMIT_SHORT_SHA.apk
  - ssh -o StrictHostKeyChecking=no fdroid@apps.funkwhale.audio 'docker run --rm -u $(id -u):$(id -g) -v /srv/fdroid/fdroid/develop:/repo registry.gitlab.com/fdroid/docker-executable-fdroidserver:master update'
  tags:
    - shell
