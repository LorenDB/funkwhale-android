image: dev.funkwhale.audio:5050/funkwhale/funkwhale-android:latest

variables:
  COBERTURA_REPORT: '$CI_PROJECT_DIR/app/build/reports/cobertura.xml'
  JACOCO_CSV_LOCATION: '$CI_PROJECT_DIR/app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.csv'
  JACOCO_XML_LOCATION: '$CI_PROJECT_DIR/app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml'

stages:
  - build_ci_env
  - test
  - visualize
  - build
  - deploy

build_ci_image:
  stage: build_ci_env
  image: egon0/docker-with-buildx-and-git:bash
  tags:
    - dind
  services:
    - docker:20-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE docker
  after_script:
    - docker push $CI_REGISTRY_IMAGE
  rules:
    - if: '$BUILD_CI_IMAGE'
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""


.gradle-default:
  before_script:
    - export GRADLE_USER_HOME=$(pwd)/.gradle
    - chmod +x ./gradlew
    - mkdir -p .android && touch .android/repositories.cfg
  script:
    - echo "Overwrite me"

  cache:
    key: ${CI_PROJECT_ID}
    paths:
      - .gradle/

.build:
  stage: build
  variables:
    apk_file: 'app/build/outputs/apk/debug/app-debug.apk'
    metadata_file: 'metadata/audio.funkwhale.android.dev.yml'
    metadata_template: 'metadata/preview.template.yml'
    output_metadata: 'app/build/outputs/apk/debug/output-metadata.json'
  before_script: 
    - git fetch --unshallow --tags
  after_script:
    - export versionCode=`$ANDROID_HOME/build-tools/30.0.2/aapt dump badging $apk_file | grep versionCode | awk '{print $3}' | sed s/versionCode=//g | sed s/\'//g`
    - apt update && apt install gettext-base
    - cat $metadata_template | envsubst > $metadata_file
  extends: .gradle-default
  artifacts:
    paths:
      - $apk_file
      - $metadata_file
      - $output_metadata

test:
  extends: .gradle-default
  stage: test
  except:
    - tags
  script:
    - ./gradlew --no-daemon --stacktrace test jacocoTestReport
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' $JACOCO_CSV_LOCATION
  artifacts:
    reports:
      junit: app/build/test-results/test**/TEST-*.xml
    paths:
      - $JACOCO_XML_LOCATION

coverage:
  stage: visualize
  image: haynes/jacoco2cobertura:1.0.8
  script:
    # convert report from jacoco to cobertura, use relative project path
    - 'python /opt/cover2cover.py $JACOCO_XML_LOCATION $CI_PROJECT_DIR/app/src/main/java > app/build/reports/cobertura.xml'
  needs: [ "test" ]
  dependencies:
    - test
  except:
    - tags
  artifacts:
    reports:
      cobertura: $COBERTURA_REPORT

build-develop:
  extends: .build
  script:
    - echo -n $PREVIEW_SIGNING_KEY_STORE | base64 -d > app/android.keystore
    - ./gradlew --stacktrace --no-daemon assembleDebug -x check -Psigning.store=android.keystore -Psigning.store_passphrase=$PREVIEW_SIGNING_KEY_PASS -Psigning.key_passphrase=$PREVIEW_SIGNING_KEY_PASS
  only:
    - develop

build-release:
  variables:
    apk_file: 'app/build/outputs/apk/release/app-release.apk'
    output_metadata: 'app/build/outputs/apk/release/output-metadata.json'
    metadata_template: 'metadata/release.template.yml'
    metadata_file: 'metadata/audio.funkwhale.android.yml'
  extends: .build
  script:
    - echo -n $SIGNING_KEY_STORE | base64 -d > app/android.keystore
    - ./gradlew --stacktrace --no-daemon assembleRelease -Psigning.store=android.keystore -Psigning.store_passphrase=$SIGNING_KEY_PASS -Psigning.key_passphrase=$SIGNING_KEY_PASS
  only:
    - tags

build-bleeding-edge:
  extends: .build
  script:
    - ./gradlew --stacktrace --no-daemon -x check assembleDebug
  except:
    - develop
    - tags

.deploy:
  image: debian
  before_script: 
    - apt update && apt -y install openssh-server

deploy-develop:
  extends: .deploy
  stage: deploy
  only:
    - develop
  script:
    - eval `ssh-agent -s`
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - scp -o StrictHostKeyChecking=no app/build/outputs/apk/debug/app-debug.apk fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/repo/audio.funkwhale.ffa.dev-$CI_COMMIT_SHORT_SHA.apk
    - scp -o StrictHostKeyChecking=no app/build/outputs/apk/debug/output-metadata.json fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/output-metadata.json
    - scp -o StrictHostKeyChecking=no metadata/audio.funkwhale.android.dev.yml fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/metadata/audio.funkwhale.ffa.dev.yml      
    - ssh -o StrictHostKeyChecking=no fdroid@apps.funkwhale.audio 'docker run --rm -u $(id -u):$(id -g) -v /srv/fdroid/fdroid/develop:/repo registry.gitlab.com/fdroid/docker-executable-fdroidserver:master update'

deploy-release:
  extends: .deploy
  stage: deploy
  only:
    - tags
  script:
    - eval `ssh-agent -s`
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - scp -o StrictHostKeyChecking=no app/build/outputs/apk/release/app-release.apk fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/repo/audio.funkwhale.ffa-$CI_COMMIT_TAG.apk
    - scp -o StrictHostKeyChecking=no app/build/outputs/apk/release/output-metadata.json fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/output-metadata.json
    - scp -o StrictHostKeyChecking=no metadata/audio.funkwhale.android.yml fdroid@apps.funkwhale.audio:/srv/fdroid/fdroid/develop/metadata/audio.funkwhale.ffa.yml      
    - ssh -o StrictHostKeyChecking=no fdroid@apps.funkwhale.audio 'docker run --rm -u $(id -u):$(id -g) -v /srv/fdroid/fdroid/develop:/repo registry.gitlab.com/fdroid/docker-executable-fdroidserver:master update'
